/*! context-traits 15-06-2015 */
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q={}.hasOwnProperty;j=function(a,b,c){var d,e,f,g;if(null==c&&(c=[]),g=this[a],null==g){if("undefined"!=typeof require&&null!==require){for(g=require(b),e=0,f=c.length;f>e;e++)d=c[e],g=g[d];return this[a]=g}throw new Error("Required object '"+a+"' of library '"+b+"' not found")}},j("_","underscore"),j("Trait","traits",["Trait"]),null==(h=Function.prototype).inheritFrom&&(h.inheritFrom=function(a){return this.prototype=new a,this}),Array.prototype.top=function(){return this[this.length-1]},c=function(a){var b;return this.activationCount=0,this.adaptations=[],this.manager=(null!=(b=i.Default)?b.manager:void 0)||new e,this.name=function(){return null!=a?a.name:void 0},this.slice=function(){return"undefined"==typeof a.slice?"context.default."+a.name:a.slice+"."+a.name},this},b=function(a,b,c){return this.context=a,this.object=b,this.trait=c,this},e=function(){return this.adaptations=[],this.invocations=[],this.policy=new a,this.totalActivations=0,this},g=function(){return this},d=function(){return this.exportingBehavior=[],this.volitileContexts=[],this},_.extend(c.prototype,{activate:function(){return 1===++this.activationCount&&(this.activationStamp=++this.manager.totalActivations,this.activateAdaptations()),this},deactivate:function(){if(!(this.activationCount>0))throw new Error("Cannot deactivate inactive context");return 0===--this.activationCount&&(this.deactivateAdaptations(),delete this.activationStamp),this},isActive:function(){return this.activationCount>0}}),m={compose:function(a,b){var c,d,e;e=Trait.compose(a.trait,b);for(c in e)if(q.call(e,c)&&(d=e[c],d.conflict))throw new Error("Property '"+c+"' already adapted for "+a.object+" in "+a.context);return e},preserve:function(a,b){return Trait.override(a.trait,b)},override:function(a,b){return Trait.override(b,a.trait)},prevent:function(a){throw new Error(a.object+" already adapted in "+a.context)}},_.extend(c.prototype,{adapt:function(a,b){if(!(a instanceof Object))throw new Error("Values of type "+typeof a+" cannot be adapted.");return i.Default.addAdaptation(a,Trait(a),m.preserve),this.addAdaptation(a,b,m.compose)},addAdaptation:function(a,c,d){var e;return c=o(c,a),e=this.adaptationFor(a),e?(e.trait=d(e,c),this.isActive()&&this.manager.updateBehaviorOf(a)):(c=Trait.compose(c,p.Extensible),e=new b(this,a,c),this.adaptations.push(e),this.isActive()&&this.manager.deployAdaptation(e)),this},adaptationFor:function(a){return _.find(this.adaptations,function(b){return b.object===a})},activateAdaptations:function(){var a,b,c,d,e;for(d=this.adaptations,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.manager.deployAdaptation(a));return e},deactivateAdaptations:function(){var a,b,c,d,e;for(d=this.adaptations,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.manager.withdrawAdaptation(a));return e}}),_.extend(e.prototype,{deployAdaptation:function(a){return this.adaptations.push(a),this.updateBehaviorOf(a.object)},withdrawAdaptation:function(a){var b;if(b=this.adaptations.indexOf(a),-1===b)throw new Error("Attempt to withdraw unmanaged adaptation");return this.adaptations.splice(b,1),this.updateBehaviorOf(a.object)},updateBehaviorOf:function(a){return this.adaptationChainFor(a)[0].deploy(),this},adaptationChainFor:function(a){var b;if(b=_.filter(this.adaptations,function(b){return b.object===a}),0===b.length)throw new Error("No adaptations found for "+a);return this.policy.order(b)}}),_.extend(b.prototype,{deploy:function(){return _.extend(this.object,Object.create({},this.trait))},toString:function(){return"Adaptation for "+this.object+" in "+this.context},equivalent:function(a){return this.context===a.context&&this.object===a.object&&Trait.eqv(this.trait,a.trait)}}),p={},p.Extensible=Trait({proceed:function(){var a,b,c,d,e,f,g,h,j;if(e=i.Default.manager,d=e.invocations,0===d.length)throw new Error("Proceed must be called from an adaptation");if(j=d.top(),h=j[0],f=j[1],g=j[2],b=j[3],b=0===arguments.length?b:arguments,a=e.orderedMethods(h,g),c=a.indexOf(f),-1===c)throw new Error("Cannot proceed from an inactive adaptation");if(c+1===a.length)throw new Error("Cannot proceed further");return a[c+1].apply(this,b)}}),n=function(a,b,c){var d;return d=function(){var e;e=i.Default.manager.invocations,e.push([a,d,b,arguments]);try{return c.apply(this,arguments)}finally{e.pop()}}},o=function(a,b){var c,d,e;d=Trait.compose(a);for(c in d)q.call(d,c)&&(e=d[c],_.isFunction(e.value)&&(e.value=n(b,c,e.value)));return d},_.extend(e.prototype,{orderedMethods:function(a,b){var c,d,e,f,g;for(d=this.adaptationChainFor(a),g=[],e=0,f=d.length;f>e;e++)c=d[e],g.push(c.trait[b].value);return g}}),_.extend(g.prototype,{order:function(a){var b;return b=this,a.sort(function(a,c){if(a.object!==c.object)throw new Error("Refusing to order adaptations of different objects");return b.compare(a,c)})},compare:function(){throw new Error("There is no criterium to order adaptations")},toString:function(){return this.name()+" policy"},name:function(){return"anonymous"}}),a=function(){return g.call(this),this},a.inheritFrom(g),_.extend(a.prototype,{compare:function(a,b){return a.context.activationAge()-b.context.activationAge()},name:function(){return"activation age"}}),_.extend(c.prototype,{activationAge:function(){return this.manager.totalActivations-this.activationStamp}}),f=function(a,b){if(null==b&&(b=null),!a)throw new Error("Namespaces must have a name");return this.name=a,this.parent=b,b||(this.home=l()),this},_.extend(f.prototype,{root:function(){return null!=this.parent?this.parent.root():this},path:function(){var a;return null!=this.parent?(a=this.parent.path(),a.push(this.name),a):[this.name]},normalizePath:function(a){if(_.isString(a))return a=a.split(".");if(_.isArray(a))return a;throw new Error("Invalid path specification")},ensure:function(a){var b,c,d,e;for(a=this.normalizePath(a),e=this,b=0,c=a.length;c>b;b++)d=a[b],null==e[d]&&(e[d]=new f(d,e)),e=e[d];return e},add:function(a){return _.extend(this,a)},load:function(a,b){var c,d;if(d=b.success||function(){},c=b.failure||function(){},a=this.normalizePath(a),"undefined"!=typeof document&&null!==document)return this.loadInBrowser(a,d,c);throw new Error("Loading of context modules not supported in current JavaScript platform.")},loadInBrowser:function(a,b,c){var d,e;if("undefined"==typeof $||null===$)throw new Error("Context module loading depends on jQuery");return d=this,e=d.root().home+d.path().concat(a).join("/")+".js",$.ajax({url:e,dataType:"text",success:function(f){var g,h,i;try{return window.hasOwnProperty("exports")&&(i=window.exports),window.exports={},$.globalEval(f),h=d.ensure(a),h.add(window.exports),null!=i?window.exports=i:delete window.exports,console.log("Loaded "+e),b()}catch(j){return g=j,c(g)}},error:function(a,b,d){return console.log("Failed to load "+e+" ("+b+"): "+d),c(d)}})}}),_.extend(c.prototype,{path:function(a){var b,c,d,e,g,h,j;if(null==a&&(a=i),d=_.keys(a),j=_.values(a),b=j.indexOf(this),-1!==b)return[d[b]];for(b=c=0,e=j.length;e>c;b=++c)if(h=j[b],h instanceof f&&"parent"!==d[b]&&(g=this.path(h)))return g.unshift(d[b]),g;return!1},name:function(){var a;return a=this.path(),a?a.join("."):"anonymous"},toString:function(){return this.name()+" context"}}),l=function(){var a,b,c,d,e,f,g;try{throw new Error}catch(h){if(a=h,g=a.stack||a.stacktrace,!g)throw new Error(a.sourceURL?"TODO: error.sourceURL not supported yet.":"Could not determine script home directory.");for(f=g.split("\n"),b=0,c=f.length;c>b;b++)if(d=f[b],e=/(http|file):\/\/[^\/]*(\/.*\/)[^\/]*\.js/.exec(d),null!=e)return e[2]}return null},i=new f("contexts"),i.Default=new c("default"),i.Default.activate(),("undefined"==typeof k||null===k)&&(k=this),k.Context=c,k.Namespace=f,k.Policy=g,k.Trait=Trait,k.contexts=i}).call(this);